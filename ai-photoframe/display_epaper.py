#!/usr/bin/env python3
"""
E-Paper Display Program for AI Photo Frame
FastSD CPUã§ç”Ÿæˆã—ãŸç”»åƒã‚’e-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã«è¡¨ç¤º

Based on: legacy-reference/app.py
Usage: 
  # ä»®æƒ³ç’°å¢ƒã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆã—ã¦ã‹ã‚‰å®Ÿè¡Œ
  source ~/fastsdcpu-project/fastsd-simple-env/bin/activate
  python3 display_epaper.py [image_path]
"""

from PIL import Image, ImageDraw, ImageFont, ImageOps
from inky.inky_uc8159 import Inky
import datetime
import os
import sys
import argparse

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
DEFAULT_IMAGE_PATH = "/home/pi/fastsdcpu-project/fastsdcpu-stable/test_output.png"
FONT_PATH = "/home/pi/font/MPLUSRounded1c-Bold.ttf"
FONT_SIZE = 18

# E-paper ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤è¨­å®šï¼ˆInky Impression 7è‰² 640x400ï¼‰
DISPLAY_WIDTH = 640
DISPLAY_HEIGHT = 400

def setup_display():
    """E-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã®åˆæœŸåŒ–"""
    try:
        # GPIOç«¶åˆå›é¿: SPIãƒ‡ãƒã‚¤ã‚¹ã‚’ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
        import subprocess
        import time
        
        print("ğŸ”§ GPIOç«¶åˆå›é¿ã®ãŸã‚SPIã‚’å†åˆæœŸåŒ–ä¸­...")
        
        # SPIãƒ‡ãƒã‚¤ã‚¹ã®ãƒªã‚»ãƒƒãƒˆè©¦è¡Œ
        try:
            subprocess.run(['sudo', 'modprobe', '-r', 'spidev'], capture_output=True)
            time.sleep(0.5)
            subprocess.run(['sudo', 'modprobe', 'spidev'], capture_output=True)
            time.sleep(0.5)
        except:
            pass  # å¤±æ•—ã—ã¦ã‚‚InkyåˆæœŸåŒ–ã‚’è©¦è¡Œ
        
        inky_display = Inky(
            resolution=(DISPLAY_WIDTH, DISPLAY_HEIGHT),
            cs_pin=8,    # å¾“æ¥é€šã‚ŠGPIO8ã‚’ä½¿ç”¨
            dc_pin=25,
            reset_pin=17,
            busy_pin=24
        )
        inky_display.set_border(inky_display.BLACK)
        print("âœ… E-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã®åˆæœŸåŒ–å®Œäº†")
        return inky_display
    except Exception as e:
        print(f"âŒ E-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã®åˆæœŸåŒ–ã«å¤±æ•—: {e}")
        print(f"   è©³ç´°: GPIO8 (CS0) ãŒä»–ã®ãƒ—ãƒ­ã‚»ã‚¹ã§ä½¿ç”¨ä¸­ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™")
        print(f"   è§£æ±ºæ–¹æ³•ã‚’è©¦è¡Œä¸­...")
        return None

def load_and_resize_image(image_path):
    """ç”»åƒã‚’èª­ã¿è¾¼ã¿ã€e-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚µã‚¤ã‚ºã«ãƒªã‚µã‚¤ã‚º"""
    try:
        if not os.path.exists(image_path):
            print(f"âŒ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {image_path}")
            return None
        
        # ç”»åƒã‚’èª­ã¿è¾¼ã¿
        img = Image.open(image_path)
        print(f"ğŸ“· ç”»åƒã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: {image_path}")
        print(f"   å…ƒã®ã‚µã‚¤ã‚º: {img.size}")
        
        # E-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã‚µã‚¤ã‚ºã«ãƒªã‚µã‚¤ã‚ºï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒï¼‰
        img.thumbnail((DISPLAY_WIDTH, DISPLAY_HEIGHT), Image.Resampling.LANCZOS)
        
        # 640x400ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆï¼ˆç™½èƒŒæ™¯ï¼‰
        canvas = Image.new('RGB', (DISPLAY_WIDTH, DISPLAY_HEIGHT), 'white')
        
        # ç”»åƒã‚’ä¸­å¤®ã«é…ç½®
        x = (DISPLAY_WIDTH - img.width) // 2
        y = (DISPLAY_HEIGHT - img.height) // 2
        canvas.paste(img, (x, y))
        
        print(f"   ãƒªã‚µã‚¤ã‚ºå¾Œ: {canvas.size}")
        return canvas
    
    except Exception as e:
        print(f"âŒ ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: {e}")
        return None

def add_timestamp_text(img, text_info=""):
    """ç”»åƒã«æ—¥æ™‚ã¨ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã‚’è¿½åŠ """
    try:
        draw = ImageDraw.Draw(img)
        
        # ãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®šï¼ˆãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒç„¡ã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆä½¿ç”¨ï¼‰
        try:
            if os.path.exists(FONT_PATH):
                font = ImageFont.truetype(FONT_PATH, FONT_SIZE, encoding='unic')
            else:
                font = ImageFont.load_default()
                print(f"âš ï¸  ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨: {FONT_PATH}")
        except:
            font = ImageFont.load_default()
            print("âš ï¸  ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨")
        
        # ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
        dt_now = datetime.datetime.now()
        disp_date = dt_now.strftime('%a, %d %b %Y %H:%M:%S')
        
        # è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆ
        if text_info:
            display_text = f'Displayed at {disp_date}\n{text_info}'
        else:
            display_text = f'Displayed at {disp_date}\nGenerated by FastSD CPU'
        
        # ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”»åƒä¸‹éƒ¨ã«æç”»ï¼ˆèƒŒæ™¯: é»’ã€æ–‡å­—: ç™½ï¼‰
        draw.text(
            (8, DISPLAY_HEIGHT - 8), 
            display_text,
            fill='white',
            stroke_width=2,
            stroke_fill='black',
            font=font,
            anchor='ld'
        )
        
        print("âœ… ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¾ã—ãŸ")
        return img
    
    except Exception as e:
        print(f"âŒ ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ ã«å¤±æ•—: {e}")
        return img

def display_on_epaper(inky_display, img):
    """e-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã«ç”»åƒã‚’è¡¨ç¤º"""
    try:
        print("ğŸ–¼ï¸  E-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã«ç”»åƒã‚’è»¢é€ä¸­...")
        inky_display.set_image(img)
        inky_display.show()
        print("âœ… E-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã¸ã®è¡¨ç¤ºå®Œäº†ï¼")
        return True
    
    except Exception as e:
        print(f"âŒ E-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤è¡¨ç¤ºã«å¤±æ•—: {e}")
        return False

def main():
    """ãƒ¡ã‚¤ãƒ³å‡¦ç†"""
    parser = argparse.ArgumentParser(description="FastSD CPUç”Ÿæˆç”»åƒã‚’E-paperã«è¡¨ç¤º")
    parser.add_argument(
        'image_path',
        nargs='?',
        default=DEFAULT_IMAGE_PATH,
        help=f'è¡¨ç¤ºã™ã‚‹ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: {DEFAULT_IMAGE_PATH})'
    )
    parser.add_argument(
        '--text',
        '-t',
        default="",
        help='ç”»åƒã«è¿½åŠ ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±'
    )
    parser.add_argument(
        '--no-timestamp',
        action='store_true',
        help='ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ ã—ãªã„'
    )
    parser.add_argument(
        '--preview',
        action='store_true',
        help='E-paperã«è¡¨ç¤ºã›ãšã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ä¿å­˜'
    )
    
    args = parser.parse_args()
    
    print("ğŸ–¼ï¸  AI Photo Frame - E-Paper Display")
    print(f"ğŸ“ ç”»åƒãƒ‘ã‚¹: {args.image_path}")
    
    # 1. ç”»åƒã®èª­ã¿è¾¼ã¿ã¨ãƒªã‚µã‚¤ã‚º
    img = load_and_resize_image(args.image_path)
    if img is None:
        sys.exit(1)
    
    # 2. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ†ã‚­ã‚¹ãƒˆã®è¿½åŠ 
    if not args.no_timestamp:
        img = add_timestamp_text(img, args.text)
    
    # 3. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ç”»åƒä¿å­˜ã®ã¿
    if args.preview:
        preview_path = "/home/pi/epaper_preview.png"
        img.save(preview_path)
        print(f"ğŸ’¾ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’ä¿å­˜: {preview_path}")
        return
    
    # 4. E-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã®åˆæœŸåŒ–
    inky_display = setup_display()
    if inky_display is None:
        print("âŒ E-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚--previewã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        sys.exit(1)
    
    # 5. E-paperãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã¸ã®è¡¨ç¤º
    success = display_on_epaper(inky_display, img)
    
    if success:
        print("ğŸ‰ AI Photo Frameè¡¨ç¤ºå®Œäº†ï¼")
    else:
        sys.exit(1)

if __name__ == "__main__":
    main()